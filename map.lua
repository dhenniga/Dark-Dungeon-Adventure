--map code
zoom_view=false
tiledat = "00000000160001001600241004000500051004100a002c0025000900080025102b000b002b002c002b002c002b00360037002c008e008f000f000f10a400a5000000000010001100341012101400150015101410250119001a003c003b001b00180025113b00260027003c003b003c003b003c009e009f001f001f10b400b500020003002b002c0003100210140115011511141129002a00080009002b002c000a002c002b000b00860087008800890082008300ae00af00a000a100a100a200120013003b003c0013101210040105010511041139003c003b003c00180019001a003c003b001b009600970098009900920093003b003c00b000b100b100b200120034011101100134111210110128002800110138010100010038010600070035003500ae0009000800251025000800ae00af00bf002c008a008b008c008d002401160101011601160124110101380038000101280110001000280117101700000000001800190018002511250118001a003c003b003c009a009b009c009d0020002100211020103001000000003011220023002310221000003a001710170000000000120013001310121001001600ae00af00a000a100a100a100a100a20030000000000030102001210121112011320000000000321000000000171017000000000023102210221023008e008f003b001b00b000b100b100b100b100b200240016000600350035000700000000003201000000003211110120002100211020101101000032103200000000000000000000000000000083108210a000a200120034001710000000001700000000002201230123112211160130000000000030101601000032113201000000000000000000000000000093109210b000b20000000000000000000000000000000000000000000000000016003001000000003011160023112211221123012f002f002f002f003f002f002f003f000000000000000000000000000000000000000000000000000000000011002001210121112011111012001301131112102f003f002f002f002f002f003f002f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080008002f002f002f000a100a002f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002f002f00080108012f000a100a002f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000025000800080025100a002f002f000a100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a002f002f000a1025010801080125110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
decoded_tiles = {}

function decode_tiles()
  for num=0,255 do
		local sx,sy=num%16,num\16
    local tile={}
    for i=0,1 do
      for j=0,1 do
				local s=(shl(sx,3)+shl(i,2))+(shl(sy,8)+shl(j,7))
        local sp=tonum("0x" .. sub(tiledat,1+s,2+s))
        local hf=sub(tiledat,3+s,3+s)=="1"
        local vf=sub(tiledat,4+s,4+s)=="1"
        add(tile,{sp=sp,hf=hf,vf=vf})
      end
    end
    decoded_tiles[num]=tile
  end
end

function spr_ex(num,x,y)
  local tile=decoded_tiles[num]
  if not tile then return end
  for i=0,1 do
    for j=0,1 do
      local t=tile[shl(i,1)+j+1]
      local sp=t.sp
			spr(sp,x+shl(i,3),y+shl(j,3),1,1,t.hf,t.vf)

    end
  end
end

function map_ex(atx, aty, m_x, m_y)
  for i=0,10 do
    for j=0,10 do
      local s=mget(m_x+(i-1),m_y+(j-1))
      spr_ex(s,shl(i-1,4)+atx,shl(j-1,4)+aty)
    end
  end
end


function update_map()
	mapx,mapy=band(p.x, 0xFFFFFF80),band(p.y, 0xFFFFFF80)
end

--

function draw_map()
	
	if zoom_view==false then
		poke(0x5f2c,0)
		if iscamfollow then

	if quake then
			local offset_x=16-rnd(32)
			local offset_y=16-rnd(32)
			offset_x*=0.05
			offset_y*=0.05
			camera(mapx-offset_x, mapy-offset_y)
	else 
		camera(mapx, mapy)
	end
	else 
			camera(p.x-64,p.y-64) 
		end
	else 	
		poke(0x5f2c,3) 
		camera(p.x-29,p.y-31)
	end

	map_ex(mapx, mapy,shr(mapx,4),shr(mapy,4))
end

--

function door_lights(x,y,fx,fy,flp)
	local flames_anim=flp and {240,241,241,240} or {224,225,225,224}
	local frame_index=flr(time()*(4*t_increment)%4)+1
	local flip=frame_index>2

	if flp then
			spr(flames_anim[frame_index],x+4,y-12,1,1,fx,flip)
			spr(flames_anim[frame_index],x+4,y+20,1,1,fx,flip)
	else
			spr(flames_anim[frame_index],x-12,y+4,1,1,flip,fy)
			spr(flames_anim[frame_index],x+20,y+4,1,1,flip,fy)
	end
end

--

function darkroom()
	memcpy(0xa000,0,0x2000)
	memcpy(0x0,0x6000,0x2000)
	poke(0x5f55,0x0)
	fillp(rnd({▒,░,…}))
	rectfill(mapx,mapy,mapx+127,mapy+127,0)
	 draw_torch_light()
	 draw_character_light()
	poke(0x5f55,0x60)
	pal({1,0,1,0,1,0,0,1,1,1,1,1,0,0,0,0})
	if zoom_view==false then
		if iscamfollow then
			sspr(0,0,128,128,mapx,mapy)
		else	
			sspr(0,0,128,128,p.x-64,p.y-64)
		end
	else
		sspr(0,0,64,64,p.x-29,p.y-31)
	end
	pal(0)	
	palt(14,true)
	palt(0,false)
	memcpy(0,0xa000,0x2000)
end